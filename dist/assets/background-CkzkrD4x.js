console.log("Trello Extension Background Service Worker Running");chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed successfully")});const s=()=>new Promise((r,l)=>{chrome.storage.local.get(["trello_api_key"],o=>{o.trello_api_key?r(o.trello_api_key):(console.error("Background: Trello API Key not found in storage."),l(new Error("Trello API Key not configured. Please set it in the extension settings.")))})}),h=()=>new Promise((r,l)=>{chrome.storage.local.get(["trello_token"],o=>{o.trello_token?(console.log("Background: Existing Trello token found in storage. Reusing it."),r(o.trello_token)):(console.log("Background: No existing Trello token found. Initiating new authentication flow."),s().then(a=>{const c=chrome.identity.getRedirectURL();console.log("Background: Using API Key:",a),console.log("Background: Generated Redirect URL:",c);const t=`https://trello.com/1/authorize?expiration=never&name=TrelloReactBooster&scope=read,write&response_type=token&key=${a}&return_url=${encodeURIComponent(c)}`;console.log("Background: Launching web auth flow with URL:",t),chrome.identity.launchWebAuthFlow({url:t,interactive:!0},e=>{if(chrome.runtime.lastError||!e){const d=chrome.runtime.lastError?chrome.runtime.lastError.message:"Web auth flow completed without a response URL.";console.error("Background: chrome.identity.launchWebAuthFlow error:",d),l(new Error(d));return}const n=new URL(e),i=new URLSearchParams(n.hash.substring(1)).get("token");i?chrome.storage.local.set({trello_token:i},()=>{console.log("Background: Trello token saved successfully."),r(i)}):(console.error("Background: No token found in response URL:",e),l(new Error("No token found in response.")))})}).catch(l))})});chrome.runtime.onMessage.addListener((r,l,o)=>{if(r.action==="save-api-key")return!r.key||typeof r.key!="string"||r.key.trim()===""?(console.error("Background: Received save-api-key request but no valid key was provided.",r),o({success:!1,error:"No valid API key provided."}),!0):(console.log("Background: Saving API key to chrome.storage.local:",r.key),chrome.storage.local.set({trello_api_key:r.key},()=>{chrome.runtime.lastError?(console.error("Background: Error saving API key:",chrome.runtime.lastError.message),o({success:!1,error:chrome.runtime.lastError.message})):(console.log("Background: API key saved to chrome.storage.local. Sending success response."),o({success:!0}))}),!0);if(r.action==="authenticate")return h().then(a=>o({success:!0,token:a})).catch(a=>o({success:!1,error:a.message})),!0;if(r.action==="get-boards"){const{token:a}=r;return s().then(c=>{const t=`https://api.trello.com/1/members/me/boards?key=${c}&token=${a}&fields=name,url,prefs&filter=open`;return fetch(t)}).then(c=>c.json()).then(c=>o({success:!0,data:c})).catch(c=>o({success:!1,error:c.message})),!0}else if(r.action==="get-board-data"){const{token:a,boardId:c}=r;return s().then(t=>{const e=`https://api.trello.com/1/boards/${c}/lists?key=${t}&token=${a}&cards=open&card_fields=name,url,pos`;return fetch(e)}).then(t=>t.json()).then(t=>o({success:!0,data:t})).catch(t=>o({success:!1,error:t.message})),!0}else if(r.action==="create-card"){const{token:a,listId:c,name:t}=r;return s().then(e=>{const n=`https://api.trello.com/1/cards?key=${e}&token=${a}&idList=${c}&name=${encodeURIComponent(t)}`;return fetch(n,{method:"POST"})}).then(e=>e.json()).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0}else if(r.action==="delete-card"){const{token:a,cardId:c}=r;return s().then(t=>{const e=`https://api.trello.com/1/cards/${c}?key=${t}&token=${a}`;return fetch(e,{method:"DELETE"})}).then(t=>{t.ok?o({success:!0}):o({success:!1,error:"Failed to delete"})}).catch(t=>o({success:!1,error:t.message})),!0}else if(r.action==="move-card"){const{token:a,cardId:c,listId:t}=r;return s().then(e=>{const n=`https://api.trello.com/1/cards/${c}?key=${e}&token=${a}&idList=${t}`;return fetch(n,{method:"PUT"})}).then(e=>e.json()).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0}else if(r.action==="get-card-details"){const{token:a,cardId:c}=r;return s().then(t=>{const e=`https://api.trello.com/1/cards/${c}?key=${t}&token=${a}&fields=name,desc,due,idLabels,idChecklists,badges,url&actions=commentCard&action_fields=data,date,memberCreator&checklists=all`;return fetch(e)}).then(async t=>{if(!t.ok){const e=await t.text();throw new Error(`Failed to fetch card details: ${t.status} ${t.statusText} - ${e}`)}return t.json()}).then(t=>o({success:!0,data:t})).catch(t=>o({success:!1,error:t.message})),!0}else if(r.action==="update-card-description"){const{token:a,cardId:c,description:t}=r;return s().then(e=>{const n=`https://api.trello.com/1/cards/${c}?key=${e}&token=${a}&desc=${encodeURIComponent(t)}`;return fetch(n,{method:"PUT"})}).then(async e=>{if(!e.ok){const n=await e.text();throw new Error(`Failed to update card description: ${e.status} ${e.statusText} - ${n}`)}return e.json()}).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0}else if(r.action==="add-comment"){const{token:a,cardId:c,commentText:t}=r;return s().then(e=>{const n=`https://api.trello.com/1/cards/${c}/actions/comments?key=${e}&token=${a}&text=${encodeURIComponent(t)}`;return fetch(n,{method:"POST"})}).then(async e=>{if(!e.ok){const n=await e.text();throw new Error(`Failed to add comment: ${e.status} ${e.statusText} - ${n}`)}return e.json()}).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0}else{if(r.action==="get-labels")return o({success:!1,error:"Not implemented yet"}),!0;if(r.action==="update-card-duedate"){const{token:a,cardId:c,dueDate:t}=r;return s().then(e=>{const n=t===null?"null":encodeURIComponent(t),u=`https://api.trello.com/1/cards/${c}?key=${e}&token=${a}&due=${n}`;return fetch(u,{method:"PUT"})}).then(async e=>{if(!e.ok){const n=await e.text();throw new Error(`Failed to update card due date: ${e.status} ${e.statusText} - ${n}`)}return e.json()}).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0}else if(r.action==="add-checklist"){const{token:a,cardId:c,name:t}=r;return s().then(e=>{const n=`https://api.trello.com/1/cards/${c}/checklists?key=${e}&token=${a}&name=${encodeURIComponent(t)}`;return fetch(n,{method:"POST"})}).then(async e=>{if(!e.ok){const n=await e.text();throw new Error(`Failed to add checklist: ${e.status} ${e.statusText} - ${n}`)}return e.json()}).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0}}});
