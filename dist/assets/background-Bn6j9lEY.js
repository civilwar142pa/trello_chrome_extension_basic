console.log("Trello Extension Background Service Worker Running");chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed successfully")});const a=()=>new Promise((e,s)=>{chrome.storage.local.get(["trello_api_key"],r=>{r.trello_api_key?e(r.trello_api_key):(console.error("Background: Trello API Key not found in storage."),s(new Error("Trello API Key not configured. Please set it in the extension settings.")))})}),h=()=>new Promise((e,s)=>{chrome.storage.local.get(["trello_token"],r=>{r.trello_token?(console.log("Background: Existing Trello token found in storage. Reusing it."),e(r.trello_token)):(console.log("Background: No existing Trello token found. Initiating new authentication flow."),a().then(c=>{const n=chrome.identity.getRedirectURL();console.log("Background: Using API Key:",c),console.log("Background: Generated Redirect URL:",n);const t=`https://trello.com/1/authorize?expiration=never&name=TrelloReactBooster&scope=read,write&response_type=token&key=${c}&return_url=${encodeURIComponent(n)}`;console.log("Background: Launching web auth flow with URL:",t),chrome.identity.launchWebAuthFlow({url:t,interactive:!0},o=>{if(chrome.runtime.lastError||!o){const u=chrome.runtime.lastError?chrome.runtime.lastError.message:"Web auth flow completed without a response URL.";console.error("Background: chrome.identity.launchWebAuthFlow error:",u),s(new Error(u));return}const l=new URL(o),i=new URLSearchParams(l.hash.substring(1)).get("token");i?chrome.storage.local.set({trello_token:i},()=>{console.log("Background: Trello token saved successfully."),e(i)}):(console.error("Background: No token found in response URL:",o),s(new Error("No token found in response.")))})}).catch(s))})});chrome.runtime.onMessage.addListener((e,s,r)=>{if(e.action==="save-api-key")return!e.key||typeof e.key!="string"||e.key.trim()===""?(console.error("Background: Received save-api-key request but no valid key was provided.",e),r({success:!1,error:"No valid API key provided."}),!0):(console.log("Background: Saving API key to chrome.storage.local:",e.key),chrome.storage.local.set({trello_api_key:e.key},()=>{chrome.runtime.lastError?(console.error("Background: Error saving API key:",chrome.runtime.lastError.message),r({success:!1,error:chrome.runtime.lastError.message})):(console.log("Background: API key saved to chrome.storage.local. Sending success response."),r({success:!0}))}),!0);if(e.action==="authenticate")return h().then(c=>r({success:!0,token:c})).catch(c=>r({success:!1,error:c.message})),!0;if(e.action==="get-boards"){const{token:c}=e;return a().then(n=>{const t=`https://api.trello.com/1/members/me/boards?key=${n}&token=${c}&fields=name,url,prefs&filter=open`;return fetch(t)}).then(n=>n.json()).then(n=>r({success:!0,data:n})).catch(n=>r({success:!1,error:n.message})),!0}else if(e.action==="get-board-data"){const{token:c,boardId:n}=e;return a().then(t=>{const o=`https://api.trello.com/1/boards/${n}/lists?key=${t}&token=${c}&cards=open&card_fields=name,url,pos`;return fetch(o)}).then(t=>t.json()).then(t=>r({success:!0,data:t})).catch(t=>r({success:!1,error:t.message})),!0}else if(e.action==="create-card"){const{token:c,listId:n,name:t}=e;return a().then(o=>{const l=`https://api.trello.com/1/cards?key=${o}&token=${c}&idList=${n}&name=${encodeURIComponent(t)}`;return fetch(l,{method:"POST"})}).then(o=>o.json()).then(o=>r({success:!0,data:o})).catch(o=>r({success:!1,error:o.message})),!0}else if(e.action==="delete-card"){const{token:c,cardId:n}=e;return a().then(t=>{const o=`https://api.trello.com/1/cards/${n}?key=${t}&token=${c}`;return fetch(o,{method:"DELETE"})}).then(t=>{t.ok?r({success:!0}):r({success:!1,error:"Failed to delete"})}).catch(t=>r({success:!1,error:t.message})),!0}else if(e.action==="move-card"){const{token:c,cardId:n,listId:t}=e;return a().then(o=>{const l=`https://api.trello.com/1/cards/${n}?key=${o}&token=${c}&idList=${t}`;return fetch(l,{method:"PUT"})}).then(o=>o.json()).then(o=>r({success:!0,data:o})).catch(o=>r({success:!1,error:o.message})),!0}});
