(function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))I(t);new MutationObserver(t=>{for(const p of t)if(p.type==="childList")for(const B of p.addedNodes)B.tagName==="LINK"&&B.rel==="modulepreload"&&I(B)}).observe(document,{childList:!0,subtree:!0});function k(t){const p={};return t.integrity&&(p.integrity=t.integrity),t.referrerPolicy&&(p.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?p.credentials="include":t.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function I(t){if(t.ep)return;t.ep=!0;const p=k(t);fetch(t.href,p)}})();document.addEventListener("DOMContentLoaded",()=>{console.log("Popup: Minimal script loaded and DOMContentLoaded fired!");const m=document.getElementById("mainContainer"),g=document.getElementById("apiKeySection"),k=document.getElementById("trelloBoardsContainer"),I=document.getElementById("apiKeyInput"),t=document.getElementById("trelloListsContainer"),p=document.getElementById("selectedBoardTitle"),B=document.getElementById("listsGrid"),J=document.getElementById("saveKeyBtn"),T=document.getElementById("status"),_=document.getElementById("boardsGrid"),u=document.getElementById("cardDetailContainer"),F=document.getElementById("cardDetailTitle"),E=document.getElementById("cardDetailDescription"),G=document.getElementById("cardDetailDueDate"),S=document.getElementById("cardDetailLabels"),$=document.getElementById("cardDetailChecklists"),M=document.getElementById("cardDetailComments"),H=document.getElementById("backToListsBtn"),P=document.getElementById("editDescriptionBtn"),x=document.getElementById("saveDescriptionBtn"),K=document.getElementById("newCommentInput"),Z=document.getElementById("addCommentBtn"),z=document.getElementById("settingsBtn"),V=document.getElementById("settingsBtnLists"),y=document.getElementById("settingsContainer"),q=document.getElementById("lightModeBtn"),j=document.getElementById("darkModeBtn"),Q=document.getElementById("backFromSettingsBtn");let L="boards";const e=(n,c=!1)=>{T&&(T.textContent=n,T.style.color=c?"red":"green",T.classList.toggle("error",c))},h=()=>{m&&(m.style.backgroundImage="",m.style.backgroundColor="#0079bf",m.classList.remove("light-text")),g&&(g.style.display="block"),k&&(k.style.display="none"),t&&(t.style.display="none"),u&&(u.style.display="none"),console.log("Popup: settingsContainer element:",y),y&&(y.style.display="block")},w=()=>{m&&(m.style.backgroundImage="",m.style.backgroundColor="var(--main-bg-color(",m.classList.remove("light-text")),g&&(g.style.display="none"),k&&(k.style.display="block"),u&&(u.style.display="none"),t&&(t.style.display="none"),y&&(y.style.display="none"),L="boards"},W=()=>{g&&(g.style.display="none"),k&&(k.style.display="none"),u&&(u.style.display="none"),t&&(t.style.display="block"),y&&(y.style.display="none"),L="lists"},re=()=>{g&&(g.style.display="none"),k&&(k.style.display="none"),t&&(t.style.display="none"),u&&(u.style.display="block"),y&&(y.style.display="none"),L="lists"};function ee(){console.log("Popup: showSettingsSection called!"),g&&(g.style.display="none"),k&&(k.style.display="none"),t&&(t.style.display="none"),u&&(u.style.display="none"),console.log("Popup: settingsContainer element:",y),y&&(y.style.display="block")}const te=async()=>{e("Authenticating with Trello...",!1);try{const n=await chrome.runtime.sendMessage({action:"authenticate"});if(!n||!n.success){e(`Authentication failed: ${n.error||"Unknown error"}`,!0),h();return}const c=n.token;e("Fetching Trello boards...",!1);const d=await chrome.runtime.sendMessage({action:"get-boards",token:c});d&&d.success&&d.data?(e(`Loaded ${d.data.length} Trello boards.`,!1),w(),_?(_.innerHTML="",d.data.forEach(a=>{const s=document.createElement("div");s.classList.add("board-block"),s.textContent=a.name,s.dataset.boardPrefs=JSON.stringify(a.prefs),a.prefs&&(a.prefs.backgroundImage?(s.style.backgroundImage=`url(${a.prefs.backgroundImage})`,a.prefs.backgroundTile?(s.style.backgroundRepeat="repeat",s.style.backgroundSize="auto"):(s.style.backgroundRepeat="no-repeat",s.style.backgroundSize="cover")):a.prefs.backgroundColor&&(s.style.backgroundColor=a.prefs.backgroundColor),a.prefs.backgroundBrightness==="light"&&s.classList.add("light-text")),s.addEventListener("click",()=>U(a.id,a.name,a.prefs)),_.appendChild(s)})):(e("Error: Boards grid element not found.",!0),console.error("Popup: boardsGrid element not found."))):(e(`Error fetching boards: ${d.error||"Unknown error"}`,!0),h())}catch(n){e(`Communication error during board fetch: ${n.message}`,!0),console.error("Popup: Error during board fetch:",n),h()}},ne=async(n,c)=>{if(!c.trim()){e("Card name cannot be empty!",!0);return}e("Creating card...",!1);try{const a=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!a){e("Trello token not found. Please re-authenticate.",!0),h();return}const s=await chrome.runtime.sendMessage({action:"create-card",token:a,listId:n,name:c});if(s&&s.success){e("Card created successfully!",!1);const l=t.dataset.boardId,r=t.dataset.boardName,o=JSON.parse(t.dataset.boardPrefs||"{}");l&&r&&o&&U(l,r,o)}else e(`Error creating card: ${s.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error creating card:",d)}},se=async(n,c)=>{if(confirm(`Are you sure you want to delete "${c}"?`)){e("Deleting card...",!1);try{const a=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!a){e("Trello token not found. Please re-authenticate.",!0),h();return}const s=await chrome.runtime.sendMessage({action:"delete-card",token:a,cardId:n});if(s&&s.success){e("Card deleted successfully!",!1);const l=t.dataset.boardId,r=t.dataset.boardName,o=JSON.parse(t.dataset.boardPrefs||"{}");l&&r&&o&&U(l,r,o)}else e(`Error deleting card: ${s.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error deleting card:",d)}}},ae=async(n,c)=>{e("Moving card...",!1);try{const a=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!a){e("Trello token not found. Please re-authenticate.",!0),h();return}const s=await chrome.runtime.sendMessage({action:"move-card",token:a,cardId:n,listId:c});if(s&&s.success){e("Card moved successfully!",!1);const l=t.dataset.boardId,r=t.dataset.boardName,o=JSON.parse(t.dataset.boardPrefs||"{}");l&&r&&o&&U(l,r,o)}else e(`Error moving card: ${s.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error moving card:",d)}},N=n=>{m&&(m.style.backgroundImage="",m.style.backgroundColor="var(--main-bg-color)",m.classList.remove("light-text"),n.backgroundImage?(m.style.backgroundImage=`url(${n.backgroundImage})`,n.backgroundTile?(m.style.backgroundRepeat="repeat",m.style.backgroundSize="auto"):(m.style.backgroundRepeat="no-repeat",m.style.backgroundSize="cover")):n.backgroundColor&&(m.style.backgroundColor=n.backgroundColor),n.backgroundBrightness==="light"&&m.classList.add("light-text"))},X=async(n,c,d)=>{e(`Fetching details for "${c}"...`,!1),N(d);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),h();return}const l=await chrome.runtime.sendMessage({action:"get-card-details",token:s,cardId:n});if(l&&l.success&&l.data){re();const r=l.data;u&&(u.dataset.cardId=r.id,u.dataset.cardName=r.name),F&&(F.textContent=r.name),E&&(E.value=r.desc||"",E.readOnly=!0,E.style.height="auto",E.style.height=E.scrollHeight+"px"),P&&(P.style.display="inline-block"),x&&(x.style.display="none"),G&&(G.textContent=r.due?`Due: ${new Date(r.due).toLocaleDateString()}`:"No due date"),S&&(S.innerHTML="",r.labels&&r.labels.length>0?r.labels.forEach(o=>{const f=document.createElement("span");f.classList.add("trello-label"),f.style.backgroundColor=o.color||"#ccc",f.textContent=o.name||o.color,S.appendChild(f)}):S.textContent="No labels"),$&&($.innerHTML="",r.checklists&&r.checklists.length>0?r.checklists.forEach(o=>{const f=document.createElement("div");f.classList.add("trello-checklist");const v=document.createElement("h4");v.textContent=o.name,f.appendChild(v);const C=document.createElement("ul");o.checkItems.forEach(D=>{const i=document.createElement("li");i.textContent=D.name,D.state==="complete"&&(i.style.textDecoration="line-through",i.style.opacity="0.7"),C.appendChild(i)}),f.appendChild(C),$.appendChild(f)}):$.textContent="No checklists"),M&&(M.innerHTML="",r.actions&&r.actions.length>0?r.actions.filter(o=>o.type==="commentCard").forEach(o=>{const f=document.createElement("div");f.classList.add("trello-comment"),f.innerHTML=`<strong>${o.memberCreator?o.memberCreator.fullName:"Unknown"}:</strong> ${o.data.text} <br> <small>${new Date(o.date).toLocaleString()}</small>`,M.appendChild(f)}):M.textContent="No comments"),e(`Details loaded for "${c}".`,!1)}else e(`Error fetching card details: ${l.error||"Unknown error"}`,!0)}catch(a){e(`Communication error during card detail fetch: ${a.message}`,!0),console.error("Popup: Error during card detail fetch:",a)}},U=async(n,c,d)=>{e(`Fetching lists for "${c}"...`,!1),t&&(t.dataset.boardId=n,t.dataset.boardName=c,t.dataset.boardPrefs=JSON.stringify(d)),N(d);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),h();return}const l=await chrome.runtime.sendMessage({action:"get-board-data",token:s,boardId:n});l&&l.success&&l.data?(W(),p&&(p.textContent=c),B&&(B.innerHTML="",l.data.forEach(r=>{const o=document.createElement("div");o.classList.add("trello-list"),o.dataset.listId=r.id,o.addEventListener("dragover",i=>{i.preventDefault(),i.dataTransfer.types.includes("text/plain")&&(o.style.backgroundColor="rgba(255,255,255,0.1)")}),o.addEventListener("dragleave",()=>{o.style.backgroundColor=""}),o.addEventListener("drop",i=>{i.preventDefault(),o.style.backgroundColor="";const b=i.dataTransfer.getData("text/plain");b&&b!=="undefined"&&ae(b,r.id)});const f=document.createElement("h3");f.classList.add("trello-list-title"),f.textContent=r.name,o.appendChild(f);const v=document.createElement("div");if(v.classList.add("cards-container"),r.cards&&r.cards.length>0)r.cards.forEach(i=>{const b=document.createElement("div");b.classList.add("trello-card"),b.setAttribute("draggable","true"),b.dataset.cardId=i.id,b.dataset.cardName=i.name,b.addEventListener("dragstart",A=>{A.dataTransfer.setData("text/plain",i.id)});const R=document.createElement("a");R.href="#",R.rel="noopener noreferrer",R.textContent=i.name,R.addEventListener("click",A=>{A.preventDefault(),X(i.id,i.name,d)}),b.appendChild(R);const O=document.createElement("button");O.classList.add("delete-card-btn"),O.textContent="Ã—",O.title=`Delete "${i.name}"`,O.addEventListener("click",A=>{A.stopPropagation(),se(i.id,i.name)}),b.appendChild(O),v.appendChild(b)});else{const i=document.createElement("p");i.classList.add("no-cards"),i.textContent="No cards in this list.",v.appendChild(i)}o.appendChild(v);const C=document.createElement("input");C.type="text",C.classList.add("add-card-input"),C.placeholder="Add a card...",C.addEventListener("keydown",i=>{i.key==="Enter"&&(ne(r.id,C.value),C.value="")}),o.appendChild(C);const D=document.createElement("button");D.classList.add("add-card-btn"),D.textContent="Add Card",D.addEventListener("click",()=>{ne(r.id,C.value),C.value=""}),o.appendChild(D),B.appendChild(o)}),e(`Loaded ${l.data.length} lists for "${c}".`,!1))):(e(`Error fetching lists: ${l.error||"Unknown error"}`,!0),w())}catch(a){e(`Communication error during list fetch: ${a.message}`,!0),console.error("Popup: Error during list fetch:",a),w()}},ce=async(n,c)=>{e("Updating description...",!1);try{const a=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!a){e("Trello token not found. Please re-authenticate.",!0),h();return}const s=await chrome.runtime.sendMessage({action:"update-card-description",token:a,cardId:n,description:c});if(s&&s.success){e("Description updated successfully!",!1);const l=u.dataset.cardId,r=u.dataset.cardName,o=JSON.parse(t.dataset.boardPrefs||"{}");l&&r&&X(l,r,o)}else e(`Error updating description: ${s.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error updating description:",d)}},de=async(n,c)=>{if(!c.trim()){e("Comment cannot be empty!",!0);return}e("Adding comment...",!1);try{const a=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!a){e("Trello token not found. Please re-authenticate.",!0),h();return}const s=await chrome.runtime.sendMessage({action:"add-comment",token:a,cardId:n,commentText:c});if(s&&s.success){e("Comment added successfully!",!1),K&&(K.value="");const l=u.dataset.cardId,r=u.dataset.cardName,o=JSON.parse(t.dataset.boardPrefs||"{}");l&&r&&X(l,r,o)}else e(`Error adding comment: ${s.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error adding comment:",d)}},Y=n=>{document.body.dataset.theme=n,chrome.storage.local.set({theme:n}),L==="lists"&&t.dataset.boardPrefs?N(JSON.parse(t.dataset.boardPrefs)):L==="boards"&&w()};chrome.storage.local.get(["trello_api_key","theme"],async n=>{const c={apiKeyInput:I,saveKeyBtn:J,statusElement:T,trelloBoardsContainer:k,boardsGrid:_,apiKeySection:g,trelloListsContainer:t,selectedBoardTitle:p,listsGrid:B,cardDetailContainer:u,cardDetailTitle:F,cardDetailDescription:E,cardDetailDueDate:G,cardDetailLabels:S,cardDetailChecklists:$,cardDetailComments:M,backToListsBtn:H,settingsBtn:z,editDescriptionBtn:P,settingsBtnLists:V,settingsContainer:y,lightModeBtn:q,darkModeBtn:j,backFromSettingsBtn:Q};for(const[d,a]of Object.entries(c))a||console.error(`Popup: Required DOM element '${d}' not found!`);Y(n.theme||"light"),n.trello_api_key?(I.value=n.trello_api_key,e("API Key found. Attempting to load boards...",!1),await te()):(h(),e("Please enter your Trello API Key.",!1)),u&&(u.style.display="none"),y&&(y.style.display="none")}),J&&I&&J.addEventListener("click",async()=>{const n=I.value.trim();if(!n){e("API Key cannot be empty!",!0);return}e("Saving API Key and authenticating...",!1),console.log("Popup: Sending save-api-key message to background.");try{const c=await chrome.runtime.sendMessage({action:"save-api-key",key:n});c&&c.success?(console.log("Popup: API Key saved successfully. Now fetching boards."),await te()):(e(`Error saving API Key: ${c.error||"Unknown error"}`,!0),console.error("Popup: Error saving API Key:",c.error))}catch(c){e(`Communication error: ${c.message}`,!0),console.error("Popup: Error sending message to background:",c)}});const oe=document.getElementById("backToBoardsBtn");oe&&oe.addEventListener("click",()=>{w(),e("Viewing Trello boards.",!1)}),H&&H.addEventListener("click",()=>{W(),t.dataset.boardPrefs&&N(JSON.parse(t.dataset.boardPrefs)),e("Viewing Trello lists.",!1)}),P&&E&&x&&(P.addEventListener("click",()=>{E.readOnly=!1,P.style.display="none",x.style.display="inline-block",E.focus()}),x.addEventListener("click",()=>{const n=u.dataset.cardId;n&&ce(n,E.value)})),Z&&K&&u&&Z.addEventListener("click",()=>de(u.dataset.cardId,K.value)),z&&(console.log("Popup: settingsBtn found, attaching listener."),z.addEventListener("click",()=>{console.log("Popup: settingsBtn clicked!"),ee()})),V&&(console.log("Popup: settingsBtnLists found, attaching listener."),V.addEventListener("click",()=>{console.log("Popup: settingsBtnLists clicked!"),ee()})),Q&&Q.addEventListener("click",()=>{L==="boards"?w():L==="lists"?(W(),t.dataset.boardPrefs&&N(JSON.parse(t.dataset.boardPrefs))):h(),e("Settings closed.",!1)}),q&&q.addEventListener("click",()=>Y("light")),j&&j.addEventListener("click",()=>Y("dark"))});
