(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))B(e);new MutationObserver(e=>{for(const u of e)if(u.type==="childList")for(const b of u.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&B(b)}).observe(document,{childList:!0,subtree:!0});function p(e){const u={};return e.integrity&&(u.integrity=e.integrity),e.referrerPolicy&&(u.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?u.credentials="include":e.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function B(e){if(e.ep)return;e.ep=!0;const u=p(e);fetch(e.href,u)}})();document.addEventListener("DOMContentLoaded",()=>{console.log("Popup: Minimal script loaded and DOMContentLoaded fired!");const i=document.getElementById("mainContainer"),f=document.getElementById("apiKeySection"),p=document.getElementById("trelloBoardsContainer"),B=document.getElementById("apiKeyInput"),e=document.getElementById("trelloListsContainer"),u=document.getElementById("selectedBoardTitle"),b=document.getElementById("listsGrid"),M=document.getElementById("saveKeyBtn"),v=document.getElementById("status"),P=document.getElementById("boardsGrid"),$=document.getElementById("settingsBtn"),K=document.getElementById("settingsBtnLists"),m=document.getElementById("settingsContainer"),A=document.getElementById("lightModeBtn"),x=document.getElementById("darkModeBtn"),O=document.getElementById("backFromSettingsBtn");let C="boards";const t=(n,s=!1)=>{v&&(v.textContent=n,v.style.color=s?"red":"green",v.classList.toggle("error",s))},k=()=>{i&&(i.style.backgroundImage="",i.style.backgroundColor="#0079bf",i.classList.remove("light-text")),f&&(f.style.display="block"),p&&(p.style.display="none"),e&&(e.style.display="none"),console.log("Popup: settingsContainer element:",m),m&&(m.style.display="block")},E=()=>{i&&(i.style.backgroundImage="",i.style.backgroundColor="var(--main-bg-color(",i.classList.remove("light-text")),f&&(f.style.display="none"),p&&(p.style.display="block"),e&&(e.style.display="none"),m&&(m.style.display="none"),C="boards"},J=()=>{f&&(f.style.display="none"),p&&(p.style.display="none"),e&&(e.style.display="block"),m&&(m.style.display="none"),C="lists"};function U(){console.log("Popup: showSettingsSection called!"),f&&(f.style.display="none"),p&&(p.style.display="none"),e&&(e.style.display="none"),console.log("Popup: settingsContainer element:",m),m&&(m.style.display="block")}const F=async()=>{t("Authenticating with Trello...",!1);try{const n=await chrome.runtime.sendMessage({action:"authenticate"});if(!n||!n.success){t(`Authentication failed: ${n.error||"Unknown error"}`,!0),k();return}const s=n.token;t("Fetching Trello boards...",!1);const a=await chrome.runtime.sendMessage({action:"get-boards",token:s});a&&a.success&&a.data?(t(`Loaded ${a.data.length} Trello boards.`,!1),E(),P&&(P.innerHTML="",a.data.forEach(o=>{const r=document.createElement("div");r.classList.add("board-block"),r.textContent=o.name,r.dataset.boardPrefs=JSON.stringify(o.prefs),o.prefs&&(o.prefs.backgroundImage?(r.style.backgroundImage=`url(${o.prefs.backgroundImage})`,o.prefs.backgroundTile?(r.style.backgroundRepeat="repeat",r.style.backgroundSize="auto"):(r.style.backgroundRepeat="no-repeat",r.style.backgroundSize="cover")):o.prefs.backgroundColor&&(r.style.backgroundColor=o.prefs.backgroundColor),o.prefs.backgroundBrightness==="light"&&r.classList.add("light-text")),r.addEventListener("click",()=>{w(o.id,o.name,o.prefs)}),P.appendChild(r)}))):(t(`Error fetching boards: ${a.error||"Unknown error"}`,!0),k())}catch(n){t(`Communication error during board fetch: ${n.message}`,!0),console.error("Popup: Error during board fetch:",n),k()}},G=async(n,s)=>{if(!s.trim()){t("Card name cannot be empty!",!0);return}t("Creating card...",!1);try{const o=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!o){t("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"create-card",token:o,listId:n,name:s});if(r&&r.success){t("Card created successfully!",!1);const g=e.dataset.boardId,c=e.dataset.boardName,d=JSON.parse(e.dataset.boardPrefs||"{}");g&&c&&d&&w(g,c,d)}else t(`Error creating card: ${r.error||"Unknown error"}`,!0)}catch(a){t(`Communication error: ${a.message}`,!0),console.error("Popup: Error creating card:",a)}},q=async(n,s)=>{if(confirm(`Are you sure you want to delete "${s}"?`)){t("Deleting card...",!1);try{const o=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!o){t("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"delete-card",token:o,cardId:n});if(r&&r.success){t("Card deleted successfully!",!1);const g=e.dataset.boardId,c=e.dataset.boardName,d=JSON.parse(e.dataset.boardPrefs||"{}");g&&c&&d&&w(g,c,d)}else t(`Error deleting card: ${r.error||"Unknown error"}`,!0)}catch(a){t(`Communication error: ${a.message}`,!0),console.error("Popup: Error deleting card:",a)}}},H=async(n,s)=>{t("Moving card...",!1);try{const o=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!o){t("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"move-card",token:o,cardId:n,listId:s});if(r&&r.success){t("Card moved successfully!",!1);const g=e.dataset.boardId,c=e.dataset.boardName,d=JSON.parse(e.dataset.boardPrefs||"{}");g&&c&&d&&w(g,c,d)}else t(`Error moving card: ${r.error||"Unknown error"}`,!0)}catch(a){t(`Communication error: ${a.message}`,!0),console.error("Popup: Error moving card:",a)}},R=n=>{i&&(i.style.backgroundImage="",i.style.backgroundColor="var(--main-bg-color)",i.classList.remove("light-text"),n.backgroundImage?(i.style.backgroundImage=`url(${n.backgroundImage})`,n.backgroundTile?(i.style.backgroundRepeat="repeat",i.style.backgroundSize="auto"):(i.style.backgroundRepeat="no-repeat",i.style.backgroundSize="cover")):n.backgroundColor&&(i.style.backgroundColor=n.backgroundColor),n.backgroundBrightness==="light"&&i.classList.add("light-text"))},w=async(n,s,a)=>{t(`Fetching lists for "${s}"...`,!1),e&&(e.dataset.boardId=n,e.dataset.boardName=s,e.dataset.boardPrefs=JSON.stringify(a)),R(a);try{const r=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!r){t("Trello token not found. Please re-authenticate.",!0),k();return}const g=await chrome.runtime.sendMessage({action:"get-board-data",token:r,boardId:n});g&&g.success&&g.data?(J(),u&&(u.textContent=s),b&&(b.innerHTML="",g.data.forEach(c=>{const d=document.createElement("div");d.classList.add("trello-list"),d.dataset.listId=c.id,d.addEventListener("dragover",l=>{l.preventDefault(),l.dataTransfer.types.includes("text/plain")&&(d.style.backgroundColor="rgba(255,255,255,0.1)")}),d.addEventListener("dragleave",()=>{d.style.backgroundColor=""}),d.addEventListener("drop",l=>{l.preventDefault(),d.style.backgroundColor="";const y=l.dataTransfer.getData("text/plain");y&&y!=="undefined"&&H(y,c.id)});const _=document.createElement("h3");_.classList.add("trello-list-title"),_.textContent=c.name,d.appendChild(_);const S=document.createElement("div");if(S.classList.add("cards-container"),c.cards&&c.cards.length>0)c.cards.forEach(l=>{const y=document.createElement("div");y.classList.add("trello-card"),y.setAttribute("draggable","true"),y.dataset.cardId=l.id,y.addEventListener("dragstart",D=>{D.dataTransfer.setData("text/plain",l.id)});const L=document.createElement("a");L.href=l.url,L.target="_blank",L.rel="noopener noreferrer",L.textContent=l.name,y.appendChild(L);const I=document.createElement("button");I.classList.add("delete-card-btn"),I.textContent="Ã—",I.title=`Delete "${l.name}"`,I.addEventListener("click",D=>{D.stopPropagation(),q(l.id,l.name)}),y.appendChild(I),S.appendChild(y)});else{const l=document.createElement("p");l.classList.add("no-cards"),l.textContent="No cards in this list.",S.appendChild(l)}d.appendChild(S);const h=document.createElement("input");h.type="text",h.classList.add("add-card-input"),h.placeholder="Add a card...",h.addEventListener("keydown",l=>{l.key==="Enter"&&(G(c.id,h.value),h.value="")}),d.appendChild(h);const T=document.createElement("button");T.classList.add("add-card-btn"),T.textContent="Add Card",T.addEventListener("click",()=>{G(c.id,h.value),h.value=""}),d.appendChild(T),b.appendChild(d)}),t(`Loaded ${g.data.length} lists for "${s}".`,!1))):(t(`Error fetching lists: ${g.error||"Unknown error"}`,!0),E())}catch(o){t(`Communication error during list fetch: ${o.message}`,!0),console.error("Popup: Error during list fetch:",o),E()}},N=n=>{document.body.dataset.theme=n,chrome.storage.local.set({theme:n}),C==="lists"&&e.dataset.boardPrefs?R(JSON.parse(e.dataset.boardPrefs)):C==="boards"&&E()};chrome.storage.local.get(["trello_api_key","theme"],async n=>{const s={apiKeyInput:B,saveKeyBtn:M,statusElement:v,trelloBoardsContainer:p,boardsGrid:P,apiKeySection:f,trelloListsContainer:e,selectedBoardTitle:u,listsGrid:b,settingsBtn:$,settingsBtnLists:K,settingsContainer:m,lightModeBtn:A,darkModeBtn:x,backFromSettingsBtn:O};for(const[a,o]of Object.entries(s))o||console.error(`Popup: Required DOM element '${a}' not found!`);N(n.theme||"light"),n.trello_api_key?(B.value=n.trello_api_key,t("API Key found. Attempting to load boards...",!1),await F()):(k(),t("Please enter your Trello API Key.",!1)),m&&(m.style.display="none")}),M&&B&&M.addEventListener("click",async()=>{const n=B.value.trim();if(!n){t("API Key cannot be empty!",!0);return}t("Saving API Key and authenticating...",!1),console.log("Popup: Sending save-api-key message to background.");try{const s=await chrome.runtime.sendMessage({action:"save-api-key",key:n});s&&s.success?(console.log("Popup: API Key saved successfully. Now fetching boards."),await F()):(t(`Error saving API Key: ${s.error||"Unknown error"}`,!0),console.error("Popup: Error saving API Key:",s.error))}catch(s){t(`Communication error: ${s.message}`,!0),console.error("Popup: Error sending message to background:",s)}});const z=document.getElementById("backToBoardsBtn");z&&z.addEventListener("click",()=>{E(),t("Viewing Trello boards.",!1)}),$&&(console.log("Popup: settingsBtn found, attaching listener."),$.addEventListener("click",()=>{console.log("Popup: settingsBtn clicked!"),U()})),K&&(console.log("Popup: settingsBtnLists found, attaching listener."),K.addEventListener("click",()=>{console.log("Popup: settingsBtnLists clicked!"),U()})),O&&O.addEventListener("click",()=>{C==="boards"?E():C==="lists"?(J(),e.dataset.boardPrefs&&R(JSON.parse(e.dataset.boardPrefs))):k(),t("Settings closed.",!1)}),A&&A.addEventListener("click",()=>N("light")),x&&x.addEventListener("click",()=>N("dark"))});
