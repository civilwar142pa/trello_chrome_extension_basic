console.log("Trello Extension Background Service Worker Running");chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed successfully")});const s=()=>new Promise((e,a)=>{chrome.storage.local.get(["trello_api_key"],o=>{o.trello_api_key?e(o.trello_api_key):(console.error("Background: Trello API Key not found in storage."),a(new Error("Trello API Key not configured. Please set it in the extension settings.")))})}),h=()=>s().then(e=>new Promise((a,o)=>{const n=chrome.identity.getRedirectURL();console.log("Background: Using API Key:",e),console.log("Background: Generated Redirect URL:",n);const c=`https://trello.com/1/authorize?expiration=never&name=TrelloReactBooster&scope=read,write&response_type=token&key=${e}&return_url=${encodeURIComponent(n)}`;console.log("Background: Launching web auth flow with URL:",c),chrome.identity.launchWebAuthFlow({url:c,interactive:!0},r=>{if(chrome.runtime.lastError||!r){const u=chrome.runtime.lastError?chrome.runtime.lastError.message:"Web auth flow completed without a response URL.";console.error("Background: chrome.identity.launchWebAuthFlow error:",u),o(new Error(u));return}const t=new URL(r),i=new URLSearchParams(t.hash.substring(1)).get("token");i?chrome.storage.local.set({trello_token:i},()=>{console.log("Background: Trello token saved successfully."),a(i)}):(console.error("Background: No token found in response URL:",r),o(new Error("No token found in response.")))})}));chrome.runtime.onMessage.addListener((e,a,o)=>{if(e.action==="save-api-key")return!e.key||typeof e.key!="string"||e.key.trim()===""?(console.error("Background: Received save-api-key request but no valid key was provided.",e),o({success:!1,error:"No valid API key provided."}),!0):(console.log("Background: Saving API key to chrome.storage.local:",e.key),chrome.storage.local.set({trello_api_key:e.key},()=>{chrome.runtime.lastError?(console.error("Background: Error saving API key:",chrome.runtime.lastError.message),o({success:!1,error:chrome.runtime.lastError.message})):(console.log("Background: API key saved to chrome.storage.local. Sending success response."),o({success:!0}))}),!0);if(e.action==="authenticate")return h().then(n=>o({success:!0,token:n})).catch(n=>o({success:!1,error:n.message})),!0;if(e.action==="get-boards"){const{token:n}=e;return s().then(c=>{const r=`https://api.trello.com/1/members/me/boards?key=${c}&token=${n}&fields=name,url,prefs&filter=open`;return fetch(r)}).then(c=>c.json()).then(c=>o({success:!0,data:c})).catch(c=>o({success:!1,error:c.message})),!0}else if(e.action==="get-board-data"){const{token:n,boardId:c}=e;return s().then(r=>{const t=`https://api.trello.com/1/boards/${c}/lists?key=${r}&token=${n}&cards=open&card_fields=name,url,pos`;return fetch(t)}).then(r=>r.json()).then(r=>o({success:!0,data:r})).catch(r=>o({success:!1,error:r.message})),!0}else if(e.action==="create-card"){const{token:n,listId:c,name:r}=e;return s().then(t=>{const l=`https://api.trello.com/1/cards?key=${t}&token=${n}&idList=${c}&name=${encodeURIComponent(r)}`;return fetch(l,{method:"POST"})}).then(t=>t.json()).then(t=>o({success:!0,data:t})).catch(t=>o({success:!1,error:t.message})),!0}else if(e.action==="delete-card"){const{token:n,cardId:c}=e;return s().then(r=>{const t=`https://api.trello.com/1/cards/${c}?key=${r}&token=${n}`;return fetch(t,{method:"DELETE"})}).then(r=>{r.ok?o({success:!0}):o({success:!1,error:"Failed to delete"})}).catch(r=>o({success:!1,error:r.message})),!0}else if(e.action==="move-card"){const{token:n,cardId:c,listId:r}=e;return s().then(t=>{const l=`https://api.trello.com/1/cards/${c}?key=${t}&token=${n}&idList=${r}`;return fetch(l,{method:"PUT"})}).then(t=>t.json()).then(t=>o({success:!0,data:t})).catch(t=>o({success:!1,error:t.message})),!0}});
