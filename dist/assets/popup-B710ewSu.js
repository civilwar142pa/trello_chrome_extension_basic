(function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))I(n);new MutationObserver(n=>{for(const p of n)if(p.type==="childList")for(const E of p.addedNodes)E.tagName==="LINK"&&E.rel==="modulepreload"&&I(E)}).observe(document,{childList:!0,subtree:!0});function h(n){const p={};return n.integrity&&(p.integrity=n.integrity),n.referrerPolicy&&(p.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?p.credentials="include":n.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function I(n){if(n.ep)return;n.ep=!0;const p=h(n);fetch(n.href,p)}})();document.addEventListener("DOMContentLoaded",()=>{console.log("Popup: Minimal script loaded and DOMContentLoaded fired!");const m=document.getElementById("mainContainer"),g=document.getElementById("apiKeySection"),h=document.getElementById("trelloBoardsContainer"),I=document.getElementById("apiKeyInput"),n=document.getElementById("trelloListsContainer"),p=document.getElementById("selectedBoardTitle"),E=document.getElementById("listsGrid"),z=document.getElementById("saveKeyBtn"),T=document.getElementById("status"),J=document.getElementById("boardsGrid"),i=document.getElementById("cardDetailContainer"),V=document.getElementById("cardDetailTitle"),B=document.getElementById("cardDetailDescription"),S=document.getElementById("cardDetailDueDateInput"),$=document.getElementById("saveDueDateBtn"),N=document.getElementById("clearDueDateBtn"),M=document.getElementById("cardDetailChecklists"),x=document.getElementById("cardDetailComments"),q=document.getElementById("backToListsBtn"),P=document.getElementById("editDescriptionBtn"),R=document.getElementById("saveDescriptionBtn"),F=document.getElementById("newCommentInput"),te=document.getElementById("addCommentBtn"),G=document.getElementById("newChecklistNameInput"),ne=document.getElementById("addChecklistBtn"),j=document.getElementById("settingsBtn"),Q=document.getElementById("settingsBtnLists"),y=document.getElementById("settingsContainer"),W=document.getElementById("lightModeBtn"),X=document.getElementById("darkModeBtn"),Y=document.getElementById("backFromSettingsBtn");let v="boards";const e=(t,c=!1)=>{T&&(T.textContent=t,T.style.color=c?"red":"green",T.classList.toggle("error",c))},k=()=>{m&&(m.style.backgroundImage="",m.style.backgroundColor="#0079bf",m.classList.remove("light-text")),g&&(g.style.display="block"),h&&(h.style.display="none"),n&&(n.style.display="none"),i&&(i.style.display="none"),console.log("Popup: settingsContainer element:",y),y&&(y.style.display="block")},w=()=>{m&&(m.style.backgroundImage="",m.style.backgroundColor="var(--main-bg-color(",m.classList.remove("light-text")),g&&(g.style.display="none"),h&&(h.style.display="block"),i&&(i.style.display="none"),n&&(n.style.display="none"),y&&(y.style.display="none"),v="boards"},Z=()=>{g&&(g.style.display="none"),h&&(h.style.display="none"),i&&(i.style.display="none"),n&&(n.style.display="block"),y&&(y.style.display="none"),v="lists"},ce=()=>{g&&(g.style.display="none"),h&&(h.style.display="none"),n&&(n.style.display="none"),i&&(i.style.display="block"),y&&(y.style.display="none"),v="lists"};function re(){console.log("Popup: showSettingsSection called!"),g&&(g.style.display="none"),h&&(h.style.display="none"),n&&(n.style.display="none"),i&&(i.style.display="none"),console.log("Popup: settingsContainer element:",y),y&&(y.style.display="block")}const oe=async()=>{e("Authenticating with Trello...",!1);try{const t=await chrome.runtime.sendMessage({action:"authenticate"});if(!t||!t.success){e(`Authentication failed: ${t.error||"Unknown error"}`,!0),k();return}const c=t.token;e("Fetching Trello boards...",!1);const d=await chrome.runtime.sendMessage({action:"get-boards",token:c});d&&d.success&&d.data?(e(`Loaded ${d.data.length} Trello boards.`,!1),w(),J?(J.innerHTML="",d.data.forEach(s=>{const r=document.createElement("div");r.classList.add("board-block"),r.textContent=s.name,r.dataset.boardPrefs=JSON.stringify(s.prefs),s.prefs&&(s.prefs.backgroundImage?(r.style.backgroundImage=`url(${s.prefs.backgroundImage})`,s.prefs.backgroundTile?(r.style.backgroundRepeat="repeat",r.style.backgroundSize="auto"):(r.style.backgroundRepeat="no-repeat",r.style.backgroundSize="cover")):s.prefs.backgroundColor&&(r.style.backgroundColor=s.prefs.backgroundColor),s.prefs.backgroundBrightness==="light"&&r.classList.add("light-text")),r.addEventListener("click",()=>H(s.id,s.name,s.prefs)),J.appendChild(r)})):(e("Error: Boards grid element not found.",!0),console.error("Popup: boardsGrid element not found."))):(e(`Error fetching boards: ${d.error||"Unknown error"}`,!0),k())}catch(t){e(`Communication error during board fetch: ${t.message}`,!0),console.error("Popup: Error during board fetch:",t),k()}},ae=async(t,c)=>{if(!c.trim()){e("Card name cannot be empty!",!0);return}e("Creating card...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"create-card",token:s,listId:t,name:c});if(r&&r.success){e("Card created successfully!",!1);const l=n.dataset.boardId,o=n.dataset.boardName,a=JSON.parse(n.dataset.boardPrefs||"{}");l&&o&&a&&H(l,o,a)}else e(`Error creating card: ${r.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error creating card:",d)}},le=async(t,c)=>{if(confirm(`Are you sure you want to delete "${c}"?`)){e("Deleting card...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"delete-card",token:s,cardId:t});if(r&&r.success){e("Card deleted successfully!",!1);const l=n.dataset.boardId,o=n.dataset.boardName,a=JSON.parse(n.dataset.boardPrefs||"{}");l&&o&&a&&H(l,o,a)}else e(`Error deleting card: ${r.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error deleting card:",d)}}},ie=async(t,c)=>{e("Moving card...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"move-card",token:s,cardId:t,listId:c});if(r&&r.success){e("Card moved successfully!",!1);const l=n.dataset.boardId,o=n.dataset.boardName,a=JSON.parse(n.dataset.boardPrefs||"{}");l&&o&&a&&H(l,o,a)}else e(`Error moving card: ${r.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error moving card:",d)}},O=t=>{m&&(m.style.backgroundImage="",m.style.backgroundColor="var(--main-bg-color)",m.classList.remove("light-text"),t.backgroundImage?(m.style.backgroundImage=`url(${t.backgroundImage})`,t.backgroundTile?(m.style.backgroundRepeat="repeat",m.style.backgroundSize="auto"):(m.style.backgroundRepeat="no-repeat",m.style.backgroundSize="cover")):t.backgroundColor&&(m.style.backgroundColor=t.backgroundColor),t.backgroundBrightness==="light"&&m.classList.add("light-text"))},_=async(t,c,d)=>{e(`Fetching details for "${c}"...`,!1),O(d);try{const r=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!r){e("Trello token not found. Please re-authenticate.",!0),k();return}const l=await chrome.runtime.sendMessage({action:"get-card-details",token:r,cardId:t});if(l&&l.success&&l.data){ce();const o=l.data;i&&(i.dataset.cardId=o.id,i.dataset.cardName=o.name),V&&(V.textContent=o.name),B&&(B.value=o.desc||"",B.readOnly=!0,B.style.height="auto",B.style.height=B.scrollHeight+"px"),P&&(P.style.display="inline-block"),R&&(R.style.display="none"),S&&(S.value=o.due?new Date(o.due).toISOString().split("T")[0]:"",$&&($.style.display="inline-block"),N&&(N.style.display="inline-block")),cardDetailLabels&&(cardDetailLabels.innerHTML="",o.labels&&o.labels.length>0?o.labels.forEach(a=>{const f=document.createElement("span");f.classList.add("trello-label"),f.style.backgroundColor=a.color||"#ccc",f.textContent=a.name||a.color,cardDetailLabels.appendChild(f)}):cardDetailLabels.textContent="No labels"),M&&(M.innerHTML="",o.checklists&&o.checklists.length>0?o.checklists.forEach(a=>{const f=document.createElement("div");f.classList.add("trello-checklist");const D=document.createElement("h4");D.textContent=a.name,f.appendChild(D);const C=document.createElement("ul");a.checkItems.forEach(L=>{const u=document.createElement("li");u.textContent=L.name,L.state==="complete"&&(u.style.textDecoration="line-through",u.style.opacity="0.7"),C.appendChild(u)}),f.appendChild(C),M.appendChild(f)}):M.textContent="No checklists"),x&&(x.innerHTML="",o.actions&&o.actions.length>0?o.actions.filter(a=>a.type==="commentCard").forEach(a=>{const f=document.createElement("div");f.classList.add("trello-comment"),f.innerHTML=`<strong>${a.memberCreator?a.memberCreator.fullName:"Unknown"}:</strong> ${a.data.text} <br> <small>${new Date(a.date).toLocaleString()}</small>`,x.appendChild(f)}):x.textContent="No comments"),e(`Details loaded for "${c}".`,!1)}else e(`Error fetching card details: ${l.error||"Unknown error"}`,!0)}catch(s){e(`Communication error during card detail fetch: ${s.message}`,!0),console.error("Popup: Error during card detail fetch:",s)}},H=async(t,c,d)=>{e(`Fetching lists for "${c}"...`,!1),n&&(n.dataset.boardId=t,n.dataset.boardName=c,n.dataset.boardPrefs=JSON.stringify(d)),O(d);try{const r=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!r){e("Trello token not found. Please re-authenticate.",!0),k();return}const l=await chrome.runtime.sendMessage({action:"get-board-data",token:r,boardId:t});l&&l.success&&l.data?(Z(),p&&(p.textContent=c),E&&(E.innerHTML="",l.data.forEach(o=>{const a=document.createElement("div");a.classList.add("trello-list"),a.dataset.listId=o.id,a.addEventListener("dragover",u=>{u.preventDefault(),u.dataTransfer.types.includes("text/plain")&&(a.style.backgroundColor="rgba(255,255,255,0.1)")}),a.addEventListener("dragleave",()=>{a.style.backgroundColor=""}),a.addEventListener("drop",u=>{u.preventDefault(),a.style.backgroundColor="";const b=u.dataTransfer.getData("text/plain");b&&b!=="undefined"&&ie(b,o.id)});const f=document.createElement("h3");f.classList.add("trello-list-title"),f.textContent=o.name,a.appendChild(f);const D=document.createElement("div");if(D.classList.add("cards-container"),o.cards&&o.cards.length>0)o.cards.forEach(u=>{const b=document.createElement("div");b.classList.add("trello-card"),b.setAttribute("draggable","true"),b.dataset.cardId=u.id,b.dataset.cardName=u.name,b.addEventListener("dragstart",U=>{U.dataTransfer.setData("text/plain",u.id)});const A=document.createElement("a");A.href="#",A.rel="noopener noreferrer",A.textContent=u.name,A.addEventListener("click",U=>{U.preventDefault(),_(u.id,u.name,d)}),b.appendChild(A);const K=document.createElement("button");K.classList.add("delete-card-btn"),K.textContent="Ã—",K.title=`Delete "${u.name}"`,K.addEventListener("click",U=>{U.stopPropagation(),le(u.id,u.name)}),b.appendChild(K),D.appendChild(b)});else{const u=document.createElement("p");u.classList.add("no-cards"),u.textContent="No cards in this list.",D.appendChild(u)}a.appendChild(D);const C=document.createElement("input");C.type="text",C.classList.add("add-card-input"),C.placeholder="Add a card...",C.addEventListener("keydown",u=>{u.key==="Enter"&&(ae(o.id,C.value),C.value="")}),a.appendChild(C);const L=document.createElement("button");L.classList.add("add-card-btn"),L.textContent="Add Card",L.addEventListener("click",()=>{ae(o.id,C.value),C.value=""}),a.appendChild(L),E.appendChild(a)}),e(`Loaded ${l.data.length} lists for "${c}".`,!1))):(e(`Error fetching lists: ${l.error||"Unknown error"}`,!0),w())}catch(s){e(`Communication error during list fetch: ${s.message}`,!0),console.error("Popup: Error during list fetch:",s),w()}},ue=async(t,c)=>{e("Updating description...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"update-card-description",token:s,cardId:t,description:c});if(r&&r.success){e("Description updated successfully!",!1);const l=i.dataset.cardId,o=i.dataset.cardName,a=JSON.parse(n.dataset.boardPrefs||"{}");l&&o&&_(l,o,a)}else e(`Error updating description: ${r.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error updating description:",d)}},se=async(t,c)=>{e("Updating due date...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}let r=null;c&&(r=new Date(c).toISOString());const l=await chrome.runtime.sendMessage({action:"update-card-duedate",token:s,cardId:t,dueDate:r});if(l&&l.success){e("Due date updated successfully!",!1);const o=i.dataset.cardId,a=i.dataset.cardName,f=JSON.parse(n.dataset.boardPrefs||"{}");o&&a&&_(o,a,f)}else e(`Error updating due date: ${l.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error updating due date:",d)}},me=async(t,c)=>{if(!c.trim()){e("Checklist name cannot be empty!",!0);return}e("Adding checklist...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"add-checklist",token:s,cardId:t,name:c});if(r&&r.success){e("Checklist added successfully!",!1),G&&(G.value="");const l=i.dataset.cardId,o=i.dataset.cardName,a=JSON.parse(n.dataset.boardPrefs||"{}");l&&o&&_(l,o,a)}else e(`Error adding checklist: ${r.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error adding checklist:",d)}},fe=async(t,c)=>{if(!c.trim()){e("Comment cannot be empty!",!0);return}e("Adding comment...",!1);try{const s=(await chrome.storage.local.get(["trello_token"])).trello_token;if(!s){e("Trello token not found. Please re-authenticate.",!0),k();return}const r=await chrome.runtime.sendMessage({action:"add-comment",token:s,cardId:t,commentText:c});if(r&&r.success){e("Comment added successfully!",!1),F&&(F.value="");const l=i.dataset.cardId,o=i.dataset.cardName,a=JSON.parse(n.dataset.boardPrefs||"{}");l&&o&&_(l,o,a)}else e(`Error adding comment: ${r.error||"Unknown error"}`,!0)}catch(d){e(`Communication error: ${d.message}`,!0),console.error("Popup: Error adding comment:",d)}},ee=t=>{document.body.dataset.theme=t,chrome.storage.local.set({theme:t}),v==="lists"&&n.dataset.boardPrefs?O(JSON.parse(n.dataset.boardPrefs)):v==="boards"&&w()};chrome.storage.local.get(["trello_api_key","theme"],async t=>{const c={apiKeyInput:I,saveKeyBtn:z,statusElement:T,trelloBoardsContainer:h,boardsGrid:J,apiKeySection:g,trelloListsContainer:n,selectedBoardTitle:p,listsGrid:E,cardDetailContainer:i,cardDetailTitle:V,cardDetailDescription:B,cardDetailDueDateInput:S,cardDetailLabels,saveDueDateBtn:$,clearDueDateBtn:N,cardDetailChecklists:M,cardDetailComments:x,backToListsBtn:q,settingsBtn:j,editDescriptionBtn:P,settingsBtnLists:Q,settingsContainer:y,lightModeBtn:W,darkModeBtn:X,backFromSettingsBtn:Y};for(const[d,s]of Object.entries(c))s||console.error(`Popup: Required DOM element '${d}' not found!`);ee(t.theme||"light"),t.trello_api_key?(I.value=t.trello_api_key,e("API Key found. Attempting to load boards...",!1),await oe()):(k(),e("Please enter your Trello API Key.",!1)),i&&(i.style.display="none"),y&&(y.style.display="none")}),z&&I&&z.addEventListener("click",async()=>{const t=I.value.trim();if(!t){e("API Key cannot be empty!",!0);return}e("Saving API Key and authenticating...",!1),console.log("Popup: Sending save-api-key message to background.");try{const c=await chrome.runtime.sendMessage({action:"save-api-key",key:t});c&&c.success?(console.log("Popup: API Key saved successfully. Now fetching boards."),await oe()):(e(`Error saving API Key: ${c.error||"Unknown error"}`,!0),console.error("Popup: Error saving API Key:",c.error))}catch(c){e(`Communication error: ${c.message}`,!0),console.error("Popup: Error sending message to background:",c)}});const de=document.getElementById("backToBoardsBtn");de&&de.addEventListener("click",()=>{w(),e("Viewing Trello boards.",!1)}),q&&q.addEventListener("click",()=>{Z(),n.dataset.boardPrefs&&O(JSON.parse(n.dataset.boardPrefs)),e("Viewing Trello lists.",!1)}),P&&B&&R&&(P.addEventListener("click",()=>{B.readOnly=!1,P.style.display="none",R.style.display="inline-block",B.focus()}),R.addEventListener("click",()=>{const t=i.dataset.cardId;t&&ue(t,B.value)})),te&&F&&i&&te.addEventListener("click",()=>fe(i.dataset.cardId,F.value)),$&&S&&i&&$.addEventListener("click",()=>{const t=i.dataset.cardId;t&&se(t,S.value)}),N&&i&&N.addEventListener("click",()=>{const t=i.dataset.cardId;t&&se(t,null)}),ne&&G&&i&&ne.addEventListener("click",()=>me(i.dataset.cardId,G.value)),j&&(console.log("Popup: settingsBtn found, attaching listener."),j.addEventListener("click",()=>{console.log("Popup: settingsBtn clicked!"),re()})),Q&&(console.log("Popup: settingsBtnLists found, attaching listener."),Q.addEventListener("click",()=>{console.log("Popup: settingsBtnLists clicked!"),re()})),Y&&Y.addEventListener("click",()=>{v==="boards"?w():v==="lists"?(Z(),n.dataset.boardPrefs&&O(JSON.parse(n.dataset.boardPrefs))):k(),e("Settings closed.",!1)}),W&&W.addEventListener("click",()=>ee("light")),X&&X.addEventListener("click",()=>ee("dark"))});
